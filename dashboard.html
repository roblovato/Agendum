<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Agendum</title>
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="scripts/firebase-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="dashboard-body">
    <div id="app">
        <!-- Components will be loaded here -->
    </div>

    <div class="modal" id="newEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Event</h2>
                <button class="close-button">&times;</button>
            </div>
            <form class="modal-form">
                <div class="form-group">
                    <label for="eventTitle">Title</label>
                    <div class="input-container">
                        <input type="text" id="eventTitle" name="title" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventDescription">Description</label>
                    <div class="input-container">
                        <textarea id="eventDescription" name="description" rows="3"></textarea>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="dateType">Event Duration</label>
                    <div class="input-container">
                        <select id="dateType" name="dateType">
                            <option value="single">Single Day</option>
                            <option value="multi">Date Range</option>
                        </select>
                    </div>
                </div>
                
                <div class="date-picker-container">
                    <!-- Single date view -->
                    <div class="form-group" id="singleDateGroup">
                        <label for="eventDate">Date</label>
                        <div class="input-container">
                            <input type="text" id="eventDate" name="date" required>
                        </div>
                    </div>

                    <!-- Date range view -->
                    <div class="form-group" id="dateRangeGroup">
                        <div class="date-range-wrapper">
                            <div class="date-input-group">
                                <label for="startDate">Start Date</label>
                                <div class="input-container">
                                    <input type="text" id="startDate" name="startDate">
                                </div>
                            </div>
                            <div class="date-input-group">
                                <label for="endDate">End Date</label>
                                <div class="input-container">
                                    <input type="text" id="endDate" name="endDate">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="eventLocation">Location</label>
                    <div class="input-container">
                        <input type="text" id="eventLocation" name="location">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="invitees">Invitees</label>
                    <div class="input-container invitees-container">
                        <div class="invitees-list" id="inviteesList">
                            <!-- Will be populated dynamically -->
                            <div class="loading-spinner">Loading contacts...</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="button primary">Create Event</button>
                    <button type="button" class="button secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="newContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactModalTitle">Add New Contact</h2>
                <button class="close-button">&times;</button>
            </div>
            <form class="modal-form" id="contactForm">
                <input type="hidden" id="contactId" name="contactId">
                <div class="form-group">
                    <label for="contactName">Name</label>
                    <div class="input-container">
                        <input type="text" id="contactName" name="name" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactEmail">Email</label>
                    <div class="input-container">
                        <input type="email" id="contactEmail" name="email" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="contactPhone">Phone Number</label>
                    <div class="input-container">
                        <input type="tel" 
                               id="contactPhone" 
                               name="phone" 
                               placeholder="(123) 456-7890"
                               pattern="\(\d{3}\)\s\d{3}-\d{4}"
                               title="Please enter a phone number in the format: (123) 456-7890">
                        <div class="input-help">Format: (123) 456-7890</div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="button primary" id="contactSubmitBtn">Add Contact</button>
                    <button type="button" class="button secondary">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal modal-form" id="deleteEventModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Event</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this event? This action cannot be undone.</p>
                <div class="event-details">
                    <p class="event-title"></p>
                    <p class="event-date"></p>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="button danger" id="confirmDeleteEventBtn">Permanently Delete</button>
                <button type="button" class="button secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal modal-form" id="deleteContactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Contact</h2>
                <button class="close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this contact? This action cannot be undone.</p>
                <div class="contact-details">
                    <p class="contact-name"></p>
                    <p class="contact-email"></p>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="button danger" id="confirmDeleteBtn">Permanently Delete</button>
                <button type="button" class="button secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { 
            createHeader, 
            createSidebar, 
            createUserNav, 
            createLoadingOverlay
        } from './scripts/components.js';

        // Import necessary functions from scripts.js
        import { 
            loadAndDisplayEvents, 
            loadAndDisplayContacts, 
            initializeDateTypeHandler, 
            loadInviteesList 
        } from './scripts/scripts.js';

        // Function to determine current view
        function getCurrentView() {
            const params = new URLSearchParams(window.location.search);
            return params.get('view') || 'events';
        }

        // Function to update URL without page reload
        function updateURL(view) {
            const url = new URL(window.location);
            url.searchParams.set('view', view);
            window.history.pushState({}, '', url);
        }

        // Function to render the appropriate view
        async function renderView(view) {
            const mainContent = document.querySelector('.main-content');
            if (!mainContent) return;

            try {
                // Wait for Firebase Auth to initialize
                await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();
                        if (user) {
                            resolve(user);
                        } else {
                            window.location.href = 'signin.html';
                        }
                    });
                });

                // Update title based on view
                document.title = `${view.charAt(0).toUpperCase() + view.slice(1)} - Agendum`;
                
                // Update content based on view
                mainContent.innerHTML = `
                    ${createHeader(view === 'events' ? 'Your Events' : 'Your Contacts')}
                    <div class="events-table ${view === 'contacts' ? 'contacts-table' : ''}">
                        <table>
                            <thead>
                                <tr>
                                    ${view === 'events' ? `
                                        <th>Title</th>
                                        <th>Date</th>
                                        <th>Location</th>
                                        <th>Invitees</th>
                                    ` : `
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                    `}
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Dynamic content will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                `;

                // Load appropriate data
                if (view === 'events') {
                    // Lazy load Flatpickr only when needed
                    if (!window.flatpickr) {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = 'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css';
                        document.head.appendChild(link);

                        await new Promise((resolve) => {
                            const script = document.createElement('script');
                            script.src = 'https://cdn.jsdelivr.net/npm/flatpickr';
                            script.onload = () => {
                                // Initialize Flatpickr after it's loaded
                                window.flatpickr = flatpickr;
                                resolve();
                            };
                            document.head.appendChild(script);
                        });
                    }
                    await loadAndDisplayEvents();
                } else {
                    await loadAndDisplayContacts();
                }

                // Update the primary button text
                const primaryButton = document.querySelector('.nav-button.primary');
                if (primaryButton) {
                    primaryButton.innerHTML = `
                        <span class="icon">+</span>
                        New ${view === 'contacts' ? 'Contact' : 'Event'}
                    `;
                }
            } catch (error) {
                console.error('Error rendering view:', error);
                if (error.message === 'User not authenticated') {
                    window.location.href = 'signin.html';
                }
            }
        }

        // Initialize the app
        document.getElementById('app').innerHTML = `
            ${createLoadingOverlay()}
            ${createSidebar(getCurrentView())}
            ${createUserNav()}
            <main class="main-content">
                <!-- Content will be loaded here -->
            </main>
        `;

        // Update the navigation handler
        document.addEventListener('click', async (e) => {
            const navButton = e.target.closest('.nav-button');
            if (!navButton) return;

            // Handle primary (New) button
            if (navButton.classList.contains('primary')) {
                e.preventDefault();
                e.stopPropagation();
                
                // Get current view from URL and close any open modals first
                const params = new URLSearchParams(window.location.search);
                const currentView = params.get('view') || 'events';
                
                // Close all modals first
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.style.display = 'none';
                });
                
                // Determine which modal to show
                if (currentView === 'contacts') {
                    const contactModal = document.getElementById('newContactModal');
                    if (contactModal) {
                        // Reset contact form
                        const form = contactModal.querySelector('form');
                        if (form) {
                            form.reset();
                            const hiddenInputs = form.querySelectorAll('input[type="hidden"]');
                            hiddenInputs.forEach(input => input.value = '');
                        }
                        
                        // Reset modal title and button
                        const modalTitle = contactModal.querySelector('#contactModalTitle');
                        const submitBtn = contactModal.querySelector('#contactSubmitBtn');
                        if (modalTitle) modalTitle.textContent = 'Add New Contact';
                        if (submitBtn) submitBtn.textContent = 'Add Contact';
                        
                        contactModal.style.display = 'block';
                    }
                    return;
                }
                
                // Handle event modal
                if (currentView === 'events') {
                    const eventModal = document.getElementById('newEventModal');
                    if (eventModal) {
                        // Reset event form
                        const form = eventModal.querySelector('form');
                        if (form) {
                            form.reset();
                        }

                        // Show modal
                        eventModal.style.display = 'block';

                        // Initialize features with a small delay to ensure DOM is ready
                        setTimeout(() => {
                            try {
                                initializeDateTypeHandler();
                                loadInviteesList();
                            } catch (error) {
                                console.error('Error initializing event features:', error);
                            }
                        }, 100);
                    }
                    return;
                }
            }

            // Handle navigation buttons
            if (navButton) {
                e.preventDefault();
                const view = navButton.getAttribute('data-view') || 'events';
                updateURL(view);
                renderView(view);
                
                // Update sidebar active state
                document.querySelectorAll('.nav-button').forEach(btn => {
                    btn.classList.toggle('active', btn.getAttribute('data-view') === view);
                });

                // Update the primary button text
                const primaryButton = document.querySelector('.nav-button.primary');
                if (primaryButton) {
                    primaryButton.innerHTML = `
                        <span class="icon">+</span>
                        New ${view === 'contacts' ? 'Contact' : 'Event'}
                    `;
                }
            }
        });

        // Handle browser back/forward
        window.addEventListener('popstate', () => {
            renderView(getCurrentView());
        });

        // Initial render
        renderView(getCurrentView());
    </script>
    <script type="module" src="scripts/scripts.js"></script>
</body>
</html> 